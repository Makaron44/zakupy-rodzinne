<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>Nawigator Rzeczywistoci</title>

    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3242/3242257.png">
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* FIX PWA: Pena wysoko ekranu i brak przewijania body */
        html,
        body {
            height: 100%;
            height: -webkit-fill-available;
            /* Specjalne dla iOS */
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            display: flex;
            flex-direction: column;
        }

        /* Nowy kontener na przewijaln tre */
        #main-scroll-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            /* Pynne przewijanie na iOS */
            padding-bottom: 40px;
            /* Minimalny odstp na dole */
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .safe-top {
            padding-top: max(1rem, env(safe-area-inset-top));
        }

        input,
        textarea,
        select {
            font-size: 16px !important;
            background: rgba(15, 23, 42, 0.6);
            color: white;
            border: 1px solid #334155;
            outline: none;
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: #a855f7;
        }

        /* Animacja Oddechu */
        .breathe-container {
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 10px;
        }

        @keyframes breathe {
            0% {
                transform: scale(1);
                opacity: 0.3;
                box-shadow: 0 0 10px rgba(168, 85, 247, 0.2);
            }

            33% {
                transform: scale(1.6);
                opacity: 1;
                box-shadow: 0 0 40px rgba(168, 85, 247, 0.5);
                border-color: #d8b4fe;
            }

            66% {
                transform: scale(1.6);
                opacity: 1;
                box-shadow: 0 0 40px rgba(168, 85, 247, 0.5);
            }

            100% {
                transform: scale(1);
                opacity: 0.3;
                box-shadow: 0 0 10px rgba(168, 85, 247, 0.2);
            }
        }

        .breathe-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(168, 85, 247, 0.4) 0%, rgba(168, 85, 247, 0) 70%);
            border: 2px solid rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.3);
            animation: breathe 12s infinite ease-in-out;
        }

        .breathe-faze {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: rgba(216, 180, 254, 0.8);
            margin-bottom: 0.5rem;
            transition: all 0.5s ease;
        }

        .breathe-timer {
            font-size: 1.5rem;
            font-weight: 300;
            color: white;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        .section-toggle {
            transition: transform 0.3s ease;
        }

        .section-collapsed .section-content {
            display: none;
        }

        .section-collapsed .section-toggle {
            transform: rotate(-90deg);
        }

        .view-section {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .view-section.active {
            display: block;
            opacity: 1;
        }

        /* Modal Generalny (Domylnie na dole - szuflada) */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            z-index: 100;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-overlay.open {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }

        /* Modal Wyrodkowany (Dla Pereek) */
        .modal-overlay.center-modal {
            align-items: center;
        }

        /* Zawarto Modala Formularza (Szuflada z dou) */
        .modal-content {
            width: 100%;
            max-width: 480px;
            border-radius: 2rem 2rem 0 0;
            padding: 1.5rem;
            background: #1e293b;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideUp 0.3s ease-out;
            max-height: 85vh;
            overflow-y: auto;
        }

        /* Animacja pulsujcego obramowania dla rodkowego modala */
        @keyframes pulseGlow {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(168, 85, 247, 0.1), 0 0 10px rgba(236, 72, 153, 0.1);
                border-color: rgba(255, 255, 255, 0.1);
            }

            50% {
                box-shadow: 0 0 25px rgba(168, 85, 247, 0.4), 0 0 35px rgba(236, 72, 153, 0.4);
                border-color: rgba(168, 85, 247, 0.5);
            }
        }

        /* Zawarto Modala Pereki (Wyrodkowane okno z pulsowaniem) */
        .modal-view-content {
            width: 90%;
            max-width: 400px;
            background: #1e293b;
            border-radius: 1.5rem;
            padding: 1.5rem;
            /* Poczenie animacji pojawiania si i pulsowania */
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), pulseGlow 3s infinite ease-in-out;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .filter-btn {
            padding: 8px 16px;
            border-radius: 99px;
            font-size: 13px;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: #94a3b8;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        #toast-container {
            position: fixed;
            top: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            pointer-events: none;
            z-index: 9999;
        }

        .toast {
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 99px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            animation: popIn 0.3s;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.error {
            background: #ef4444;
        }

        /* Dziennik */
        .tag-btn {
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 11px;
            background: rgba(255, 255, 255, 0.05);
            color: #cbd5e1;
            transition: all 0.2s;
        }

        .tag-btn.selected {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        .status-btn {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: 2px solid transparent;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.05);
            color: #64748b;
        }

        .status-btn.fed.active {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }

        .status-btn.ext.active {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
            color: #10b981;
        }

        .status-btn.active.fed {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .status-btn.active.ext {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .btn-action {
            padding: 0.5rem 0.75rem;
            border-radius: 0.75rem;
            transition: all 0.2s;
            transform: scale(1);
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-action:active {
            transform: scale(0.9);
        }

        .btn-ai {
            background: rgba(139, 92, 246, 0.1);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .btn-edit {
            background: rgba(245, 158, 11, 0.1);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        /* SIDEBAR / HAMBURGER MENU */
        #sidebar {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            z-index: 1000;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #sidebar.open {
            left: 0;
            box-shadow: 20px 0 50px rgba(0, 0, 0, 0.5);
        }

        #sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-item {
            padding: 15px 20px;
            border-radius: 16px;
            color: #94a3b8;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .sidebar-item.active {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            border-left: 3px solid #60a5fa;
        }


        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes popIn {
            from {
                transform: scale(0.5);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="safe-top">

    <div id="toast-container"></div>
    <div id="debug-console"></div>

    <div id="main-scroll-container">
        <header class="px-6 py-4 flex justify-between items-center sticky top-0 z-30 backdrop-blur-md bg-[#0f172a]/80">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="p-2 glass rounded-xl active:scale-95">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <div>
                    <h1
                        class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">
                        Nawigator</h1>
                </div>
            </div>
            <button onclick="switchTab('settings')" class="p-2 glass rounded-xl transition-all active:scale-95">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                    </path>
                </svg>
            </button>
        </header>

        <main id="app-content" class="px-4 space-y-6">

            <div id="tab-dashboard" class="view-section active">
                <section class="space-y-3">
                    <h2 class="text-sm font-bold text-purple-400 px-1">Twoje Nastawienie</h2>
                    <div
                        class="glass rounded-3xl p-6 bg-gradient-to-br from-purple-900/20 to-slate-900 border-purple-500/20">
                        <div id="amalgam-display" class="hidden text-center space-y-4">
                            <p class="text-xl font-medium italic text-slate-100" id="amalgam-text"></p>
                            <button onclick="speakAmalgam()"
                                class="flex items-center justify-center gap-2 mx-auto bg-purple-600/20 hover:bg-purple-600/40 text-purple-300 px-4 py-2 rounded-full text-xs font-bold transition-colors">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                                </svg>
                                ODSUCHAJ
                            </button>
                            <button onclick="resetAmalgam()"
                                class="text-xs text-slate-500 underline block mx-auto mt-2">Ustaw nowy cel</button>
                        </div>
                        <div id="amalgam-form" class="space-y-4">
                            <p class="text-xs text-slate-400">Co Ci dzi stresuje?</p>
                            <div class="flex gap-2">
                                <input type="text" id="challenge-input" placeholder="Wpisz problem..."
                                    class="flex-1 rounded-2xl px-4 py-3">
                                <button onclick="generateAmalgam()" id="btn-generate"
                                    class="bg-purple-600 p-3 rounded-2xl text-white active:scale-95">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <line x1="22" y1="2" x2="11" y2="13"></line>
                                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="breathe-section" class="space-y-3">
                    <div class="flex justify-between items-center px-1 cursor-pointer" onclick="toggleBreatheSection()">
                        <h2
                            class="text-sm font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-purple-400">
                            Koherencja Serca</h2>
                        <svg id="breathe-toggle" class="section-toggle text-purple-400" width="16" height="16"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                    <div
                        class="glass rounded-3xl p-8 flex flex-col items-center justify-center border-slate-700/50 section-content relative overflow-hidden">
                        <div class="absolute inset-0 bg-purple-500/5 pointer-events-none"></div>
                        <div id="breathe-faze" class="breathe-faze">PRZYGOTOWANIE</div>
                        <div class="breathe-container">
                            <div class="breathe-circle"></div>
                            <div id="breathe-timer"
                                class="absolute inset-0 flex items-center justify-center text-xl font-bold text-white/40 font-mono">
                                5</div>
                        </div>
                        <p class="text-[9px] text-slate-500 uppercase tracking-widest text-center mt-4 opacity-60">
                            Synchronizacja Serca i Umysu</p>
                    </div>
                </section>

                <section class="space-y-3">
                    <div class="flex justify-between items-center px-1">
                        <h2 class="text-sm font-bold text-red-400">SOS</h2>
                        <button onclick="openModal('pearl', ' SOS')" class="text-slate-400 p-2"><svg width="24"
                                height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="16"></line>
                                <line x1="8" y1="12" x2="16" y2="12"></line>
                            </svg></button>
                    </div>
                    <div id="sos-container" class="space-y-3"></div>
                </section>
            </div>

            <div id="tab-wiedza" class="view-section">
                <div class="flex flex-col gap-4 mb-4">
                    <div class="flex justify-between items-center mb-6 px-1">
                        <h2
                            class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-400">
                            Baza Wiedzy</h2>
                        <button onclick="openModal('pearl')"
                            class="bg-blue-600 p-3 rounded-2xl text-white shadow-lg shadow-blue-500/20 active:scale-90 flex items-center gap-2">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2.5">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="mb-4">
                        <div class="flex gap-2 overflow-x-auto pb-4 no-scrollbar" id="filter-bar">
                            <button onclick="setFilter('ALL', this)" class="filter-btn active">Wszystkie</button>
                            <button onclick="setFilter(' SOS', this)" class="filter-btn">SOS</button>
                            <button onclick="setFilter(' ZASADA', this)" class="filter-btn">Zasada</button>
                            <button onclick="setFilter(' SLAJD', this)" class="filter-btn">Slajd</button>
                            <button onclick="setFilter(' SPOKJ', this)" class="filter-btn">Spok贸j</button>
                            <button onclick="setFilter(' FINANSE', this)" class="filter-btn">Finanse</button>
                            <button onclick="setFilter('わ ZDROWIE', this)" class="filter-btn">Zdrowie</button>
                            <button onclick="setFilter(' RELACJE', this)" class="filter-btn">Relacje</button>
                        </div>
                    </div>
                </div>
                <div id="wiedza-container" class="space-y-4 pb-20"></div>
            </div>

            <div id="tab-dziennik" class="view-section">
                <div class="flex justify-between items-center mb-4 px-1">
                    <h2
                        class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-teal-400">
                        Dziennik</h2>
                    <button onclick="openModal('journal')"
                        class="bg-emerald-600 p-3 rounded-2xl text-white shadow-lg shadow-emerald-500/20 active:scale-90 flex items-center gap-2">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                </div>

                <div class="flex gap-2 overflow-x-auto pb-4 no-scrollbar" id="journal-filter-bar">
                    <button onclick="setJournalFilter('ALL')" class="filter-btn active"
                        id="jfilter-all">Wszystkie</button>
                    <button onclick="setJournalFilter('fed')" class="filter-btn" id="jfilter-fed">Nakarmione </button>
                    <button onclick="setJournalFilter('ext')" class="filter-btn" id="jfilter-ext">Wygaszone </button>
                </div>

                <div class="glass rounded-2xl p-4 flex items-center gap-2 mb-4">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" id="journal-search" oninput="renderJournal()" placeholder="Szukaj w haczykach..."
                        class="bg-transparent border-none w-full p-0">
                </div>
                <div id="journal-container" class="space-y-4 pb-20"></div>
            </div>

            <div id="tab-analiza" class="view-section space-y-6">
                <div>
                    <h2
                        class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 mb-4 px-1">
                        Trend Energii</h2>
                    <div class="glass rounded-3xl p-6 h-72 border-purple-500/10 relative overflow-hidden bg-[#161e31]">
                        <div
                            class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-5">
                        </div>
                        <div id="chart-container" class="w-full h-full relative z-10"></div>
                    </div>
                    <p class="text-center text-[10px] text-slate-500 mt-2">Ostatnie 7 dni aktywnoci</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="glass rounded-3xl p-5 border-emerald-500/10 flex flex-col items-center text-center">
                        <p class="text-[9px] text-slate-500 uppercase tracking-widest mb-3">Uwa偶no</p>
                        <div class="relative w-16 h-16 flex items-center justify-center">
                            <svg class="w-full h-full transform -rotate-90">
                                <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="4" fill="transparent"
                                    class="text-slate-800" />
                                <circle id="balance-circle" cx="32" cy="32" r="28" stroke="currentColor"
                                    stroke-width="4" fill="transparent" stroke-dasharray="176" stroke-dashoffset="176"
                                    class="text-emerald-500 transition-all duration-1000" />
                            </svg>
                            <span id="balance-score" class="absolute text-sm font-bold text-white">0%</span>
                        </div>
                        <p class="text-[10px] text-emerald-400 mt-3 font-bold uppercase">Wygaszone</p>
                    </div>

                    <div class="glass rounded-3xl p-5 border-red-500/10">
                        <p class="text-[9px] text-slate-500 uppercase tracking-widest mb-3 text-center">Top Wahada</p>
                        <div id="top-pendulums" class="space-y-2">
                            <p class="text-[10px] text-slate-500 text-center py-2 italic uppercase">Brak danych</p>
                        </div>
                    </div>
                </div>

                <div class="glass rounded-3xl p-6 border-purple-500/20 relative overflow-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-2">
                            <div class="p-2 bg-purple-900/30 rounded-lg text-purple-400">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path
                                        d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83">
                                    </path>
                                </svg>
                            </div>
                            <h3 class="text-sm font-bold text-slate-200 uppercase tracking-wider">Tygodniowy Mentor AI
                            </h3>
                        </div>
                        <button onclick="runWeeklyAIReview()" id="btn-weekly-ai"
                            class="text-[10px] font-bold text-purple-400 uppercase tracking-widest px-3 py-1 bg-purple-900/30 rounded-full active:scale-95 transition-all">Generuj</button>
                    </div>
                    <div id="weekly-ai-review"
                        class="text-xs text-slate-400 leading-relaxed italic min-h-[60px] flex items-center justify-center text-center">
                        Kliknij tekst lub przycisk, aby przeanalizowa wzorce z ostatniego tygodnia...
                    </div>
                </div>
                <div class="pb-20"></div>
            </div>

            <div id="tab-settings" class="view-section">
                <h2 class="text-xl font-bold mb-4 px-1">Ustawienia</h2>

                <div class="glass rounded-3xl p-6 space-y-4 border border-blue-500/20 mb-4">
                    <div class="flex items-center gap-3 mb-2">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2">
                            <path
                                d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4">
                            </path>
                        </svg>
                        <h3 class="text-sm font-bold text-slate-200">Klucz API Gemini</h3>
                    </div>
                    <input type="password" id="api-key-input" onchange="saveApiKey()" placeholder="Wklej klucz API..."
                        class="w-full rounded-xl p-4 font-mono text-xs bg-slate-800">
                </div>

                <div class="glass rounded-3xl p-6 space-y-4 border border-emerald-500/20 mb-4">
                    <h3 class="text-sm font-bold text-slate-200">Kopia Zapasowa</h3>
                    <div class="flex gap-2">
                        <button onclick="downloadBackup()"
                            class="flex-1 py-3 bg-slate-800 rounded-xl text-xs font-bold text-emerald-400 border border-emerald-500/30">POBIERZ</button>
                        <label
                            class="flex-1 py-3 bg-slate-800 rounded-xl text-xs font-bold text-blue-400 border border-blue-500/30 text-center cursor-pointer">
                            WGRAJ
                            <input type="file" onchange="uploadBackup(this)" class="hidden" accept=".json">
                        </label>
                    </div>
                </div>

                <button onclick="hardReset()"
                    class="w-full py-4 mt-6 glass text-red-400 rounded-2xl font-bold border-red-500/20">RESET
                    DANYCH</button>
            </div>
    </div>
    </div>

    <!-- SIDEBAR OVERLAY -->
    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- SIDEBAR MENU -->
    <div id="sidebar">
        <div class="mb-8 px-4">
            <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400">
                Nawigator</h2>
            <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Menu Aplikacji</p>
        </div>

        <div class="space-y-2">
            <div onclick="sidebarSelect('dashboard')" id="side-dashboard" class="sidebar-item active">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span>Dzi</span>
            </div>
            <div onclick="sidebarSelect('wiedza')" id="side-wiedza" class="sidebar-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
                <span>Wiedza</span>
            </div>
            <div onclick="sidebarSelect('dziennik')" id="side-dziennik" class="sidebar-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                <span>Dziennik</span>
            </div>
            <div onclick="sidebarSelect('analiza')" id="side-analiza" class="sidebar-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                    <polyline points="17 6 23 6 23 12"></polyline>
                </svg>
                <span>Analiza</span>
            </div>
        </div>

        <div class="mt-auto pt-4 border-t border-white/5 space-y-2">
            <div onclick="sidebarSelect('settings')" id="side-settings" class="sidebar-item">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l-.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                    </path>
                </svg>
                <span class="text-sm italic">Ustawienia</span>
            </div>
            <div onclick="startQRScanner()" class="sidebar-item text-blue-400 border-t border-white/5 mt-2 pt-4">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                <span class="text-sm font-bold uppercase tracking-tighter">Skanuj QR</span>
            </div>
        </div>
    </div>

    <div id="modal-view-pearl" class="modal-overlay center-modal" onclick="handleModalClick(event, 'view-pearl')">
        <div class="modal-view-content glass flex flex-col gap-4 text-center">
            <div id="view-icon" class="mx-auto p-4 rounded-full bg-slate-800 mb-2 w-fit"></div>
            <h3 id="view-title" class="text-2xl font-bold text-white leading-tight"></h3>
            <p id="view-desc" class="text-slate-300 text-sm leading-relaxed mt-2"></p>
            <div class="border-t border-white/10 pt-4 mt-2">
                <p class="text-[10px] text-slate-500 uppercase tracking-widest mb-2">Afirmacja</p>
                <p id="view-affirm" class="text-lg font-bold text-emerald-400 leading-snug"></p>
            </div>

            <div id="view-qr-container"
                class="hidden flex flex-col items-center gap-2 mt-2 p-4 bg-white rounded-2xl mx-auto">
                <div id="view-qr-code"></div>
                <p class="text-[9px] text-slate-900 font-bold uppercase">Skanuj telefonem</p>
            </div>

            <div class="flex gap-2 mt-2">
                <button id="btn-show-qr" onclick="generatePearlQR()"
                    class="flex-1 py-3 bg-blue-600/20 text-blue-400 rounded-xl font-bold text-[10px] border border-blue-500/30 flex items-center justify-center gap-2 uppercase">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Transfer QR
                </button>
                <button onclick="closeModal('view-pearl')"
                    class="flex-1 py-3 bg-slate-800 rounded-xl text-slate-400 font-bold text-[10px] uppercase">Zamknij</button>
            </div>
        </div>
    </div>

    <div id="modal-pearl" class="modal-overlay" onclick="handleModalClick(event, 'pearl')">
        <div class="modal-content glass">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-blue-400 text-lg">Nowa Pereka</h3>
                <button onclick="closeModal('pearl')" class="p-2 text-slate-400"><svg width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg></button>
            </div>
            <div class="space-y-4">
                <select id="p-cat" class="w-full rounded-2xl p-4">
                    <option value=" SOS"> SOS</option>
                    <option value=" SLAJD"> SLAJD</option>
                    <option value=" ZASADA"> ZASADA</option>
                    <option value=" SPOKJ"> SPOKJ</option>
                    <option value=" FINANSE"> FINANSE</option>
                    <option value="わ ZDROWIE">わ ZDROWIE</option>
                    <option value=" RELACJE"> RELACJE</option>
                </select>
                <input id="p-title" placeholder="Tytu..." class="w-full rounded-2xl p-4">
                <textarea id="p-desc" placeholder="Tre..." class="w-full rounded-2xl p-4 h-24"></textarea>
                <input id="p-affirm" placeholder="Afirmacja..." class="w-full rounded-2xl p-4">
                <button type="button" onclick="addPearl()"
                    class="w-full py-4 bg-blue-600 rounded-2xl font-bold text-white shadow-lg">ZAPISZ</button>
            </div>
        </div>
    </div>

    <div id="modal-qr-scanner" class="modal-overlay center-modal" onclick="handleModalClick(event, 'qr-scanner')">
        <div class="modal-view-content glass flex flex-col gap-4 text-center max-w-[90%]">
            <h3 class="text-xl font-bold text-white uppercase tracking-wider">Skaner Transferu</h3>
            <p class="text-[10px] text-slate-400">Skieruj aparat na kod QR</p>
            <div id="reader" class="rounded-2xl overflow-hidden bg-black aspect-square w-full"></div>
            <button onclick="stopQRScanner()"
                class="mt-4 py-4 w-full bg-slate-800 rounded-2xl text-slate-400 font-bold text-xs uppercase">Anuluj</button>
        </div>
    </div>

    <div id="modal-journal" class="modal-overlay" onclick="handleModalClick(event, 'journal')">
        <div class="modal-content glass">
            <div class="flex justify-between items-center mb-4">
                <h3 id="j-modal-title" class="font-bold text-emerald-400 text-lg">Nowy Wpis</h3>
                <button onclick="closeModal('journal')" class="p-2 text-slate-400"><svg width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg></button>
            </div>
            <div class="space-y-4">
                <input type="hidden" id="j-edit-id" value="">

                <div>
                    <label class="text-[10px] text-slate-500 ml-1 mb-1 block uppercase">Zasada Transerfingu</label>
                    <select id="j-principle"
                        class="w-full rounded-2xl p-4 bg-slate-800/50 border border-white/5 text-slate-200">
                        <option value="">Brak konkretnej zasady</option>
                        <option value="Wa偶no">Nadmierna Wa偶no</option>
                        <option value="Wahada">Walka z Wahadem</option>
                        <option value="Koordynacja">Koordynacja Zamiaru</option>
                        <option value="Slajd">Praca ze Slajdem</option>
                        <option value="Jedno">Jedno Duszy i Umysu</option>
                        <option value="Frajling">Frajling (Relacje)</option>
                    </select>
                </div>

                <div>
                    <label class="text-[10px] text-slate-500 ml-1 mb-1 block uppercase">Status Wahada</label>
                    <div class="flex gap-2">
                        <button type="button" id="status-fed" onclick="setPendulumStatus('fed')"
                            class="status-btn fed flex-1">Nakarmione </button>
                        <button type="button" id="status-ext" onclick="setPendulumStatus('ext')"
                            class="status-btn ext flex-1">Wygaszone </button>
                    </div>
                </div>

                <input type="hidden" id="j-status" value="">

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] text-slate-500 ml-1 mb-1 block uppercase">Energia (1-5)</label>
                        <input type="number" id="j-energy" min="1" max="5" value="3"
                            class="w-full rounded-2xl p-4 bg-slate-800/50 border border-white/5 text-slate-200">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 ml-1 mb-1 block uppercase">Tagi</label>
                        <div class="flex flex-wrap gap-1" id="j-quick-tags">
                            <button type="button" onclick="toggleTag(this)" class="tag-btn text-[9px]">Stres</button>
                            <button type="button" onclick="toggleTag(this)" class="tag-btn text-[9px]">Praca</button>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] text-slate-500 ml-1 mb-1 block uppercase">Haczyk (Opis sytuacji)</label>
                    <input id="j-hook" placeholder="Co si stao?"
                        class="w-full rounded-2xl p-4 bg-slate-800/50 border border-white/5 text-slate-200">
                </div>

                <div>
                    <label class="text-[10px] text-slate-500 ml-1 mb-1 block uppercase">Wniosek / wiadomo</label>
                    <textarea id="j-concl" placeholder="Twoja reakcja..."
                        class="w-full rounded-2xl p-4 h-24 bg-slate-800/50 border border-white/5 text-slate-200"></textarea>
                </div>

                <button onclick="addJournal()" id="j-submit-btn"
                    class="w-full py-4 bg-emerald-600 rounded-2xl font-bold text-white shadow-lg shadow-emerald-500/20 active:scale-95 transition-transform">ZAPISZ
                    WPIS</button>
            </div>
        </div>

        <script>
            function logError(msg) { console.error(msg); }
            window.onerror = function (msg, url, line) { if (!msg.includes('ResizeObserver')) console.error(msg); };

            // --- STATE ---
            const INITIAL_PEARLS = [
                { id: "1", kategoria: " SOS", tytul: "Presja Czasu", trescPorady: "Zejd藕 z linii ciosu. To tylko cyfry.", afirmacjaSkrot: "M贸j wiat dba o m贸j spok贸j." },
                { id: "2", kategoria: " SLAJD", tytul: "Bezpieczna Trasa", trescPorady: "Widzisz zielone wiata i pust drog.", afirmacjaSkrot: "Pyn w Prdzie Wariant贸w." }
            ];

            let state = { pearls: [], journal: [], amalgam: "", apiKey: "", filter: 'ALL', journalFilter: 'ALL', breatheCollapsed: false };
            let currentTags = []; // Tagi dla nowego wpisu

            // --- STORAGE (INDEXEDDB) ---
            const DB_NAME = 'NawigatorDB';
            const DB_VERSION = 1;

            async function initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('state')) db.createObjectStore('state');
                    };
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            async function saveState() {
                const db = await initDB();
                const tx = db.transaction('state', 'readwrite');
                tx.objectStore('state').put(state, 'current');
                return new Promise((resolve) => tx.oncomplete = resolve);
            }

            async function loadState() {
                const db = await initDB();
                const tx = db.transaction('state', 'readonly');
                const data = await new Promise(resolve => tx.objectStore('state').get('current').onsuccess = (e) => resolve(e.target.result));

                if (data) {
                    state = data;
                } else {
                    // Migracja z localStorage
                    try {
                        const oldPearls = JSON.parse(localStorage.getItem('nr_pearls'));
                        const oldJournal = JSON.parse(localStorage.getItem('nr_journal'));
                        if (oldPearls) state.pearls = oldPearls;
                        if (oldJournal) state.journal = oldJournal;
                        state.amalgam = localStorage.getItem('nr_amalgam') || "";
                        state.apiKey = localStorage.getItem('nr_api_key') || "";
                        await saveState();
                    } catch (e) { state.pearls = INITIAL_PEARLS; }
                }
                if (!state.pearls || state.pearls.length === 0) state.pearls = INITIAL_PEARLS;
            }

            function save() { saveState(); }

            // --- FILTER ---
            function setFilter(category, btn) {
                state.filter = category;
                renderWiedza();
            }

            // --- MODAL VIEW ---
            function viewPearl(id) {
                const pearl = state.pearls.find(p => p.id === id);
                if (!pearl) return;

                // Reset QR
                document.getElementById('view-qr-container').classList.add('hidden');
                document.getElementById('btn-show-qr').classList.remove('hidden');
                document.getElementById('modal-view-pearl').dataset.category = pearl.kategoria;

                document.getElementById('view-title').textContent = pearl.tytul;
                document.getElementById('view-desc').textContent = `"${pearl.trescPorady}"`;
                document.getElementById('view-affirm').textContent = pearl.afirmacjaSkrot;

                const iconContainer = document.getElementById('view-icon');
                let color = "text-blue-400";
                let iconSvg = "";
                if (pearl.kategoria.includes("SOS")) {
                    color = "text-red-400";
                    iconSvg = '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>';
                } else if (pearl.kategoria.includes("SLAJD")) {
                    color = "text-purple-400";
                    iconSvg = '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>';
                } else if (pearl.kategoria.includes("RELACJE")) {
                    color = "text-pink-400";
                    iconSvg = '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>';
                } else {
                    color = "text-blue-400";
                    iconSvg = '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>';
                }
                iconContainer.innerHTML = iconSvg;
                iconContainer.className = `mx-auto p-4 rounded-full bg-slate-800 mb-2 w-fit ${color}`;
                openModal('view-pearl');
            }

            function generatePearlQR() {
                const title = document.getElementById('view-title').textContent;
                const desc = document.getElementById('view-desc').textContent.replace(/^"|"$/g, '');
                const affirm = document.getElementById('view-affirm').textContent;
                const category = document.getElementById('modal-view-pearl').dataset.category || " ZASADA";

                const data = {
                    type: 'pearl',
                    pearl: {
                        id: 'qr_' + Date.now(),
                        kategoria: category,
                        tytul: title,
                        trescPorady: desc,
                        afirmacjaSkrot: affirm
                    }
                };

                const qrDiv = document.getElementById('view-qr-code');
                qrDiv.innerHTML = "";
                document.getElementById('view-qr-container').classList.remove('hidden');

                new QRCode(qrDiv, {
                    text: JSON.stringify(data),
                    width: 160,
                    height: 160,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                document.getElementById('btn-show-qr').classList.add('hidden');
            }

            let html5QrCode = null;

            async function startQRScanner() {
                toggleSidebar();
                openModal('qr-scanner');
                setTimeout(async () => {
                    try {
                        html5QrCode = new Html5Qrcode("reader");
                        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                        await html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess);
                    } catch (err) {
                        alert("Bd aparatu: " + err);
                        stopQRScanner();
                    }
                }, 300);
            }

            function stopQRScanner() {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => {
                        html5QrCode.clear();
                        closeModal('qr-scanner');
                    }).catch(err => closeModal('qr-scanner'));
                } else {
                    closeModal('qr-scanner');
                }
            }

            function onScanSuccess(decodedText) {
                stopQRScanner();
                try {
                    const data = JSON.parse(decodedText);
                    if (data.type === 'pearl' && data.pearl) {
                        const exists = state.pearls.find(p => p.id === data.pearl.id || (p.tytul === data.pearl.tytul && p.trescPorady === data.pearl.trescPorady));
                        if (exists) {
                            showToast("Ta pereka ju偶 jest w Twojej bazie.");
                        } else {
                            state.pearls.push(data.pearl);
                            save();
                            refreshAllViews();
                            showToast("Pomylnie zaimportowano perek! ");
                        }
                    } else { alert("Nieznany format kodu."); }
                } catch (e) { alert("Bd odczytu danych QR."); }
            }

            // --- JOURNAL LOGIC ---
            function setPendulumStatus(status) {
                document.getElementById('j-status').value = status;
                document.getElementById('status-fed').classList.remove('active');
                document.getElementById('status-ext').classList.remove('active');
                document.getElementById(`status-${status}`).classList.add('active');
            }

            function setJournalFilter(f) {
                state.journalFilter = f;
                document.querySelectorAll('#journal-filter-bar .filter-btn').forEach(btn => btn.classList.remove('active'));
                if (f === 'ALL') document.getElementById('jfilter-all').classList.add('active');
                else if (f === 'fed') document.getElementById('jfilter-fed').classList.add('active');
                else if (f === 'ext') document.getElementById('jfilter-ext').classList.add('active');
                renderJournal();
            }

            function toggleTag(btn) {
                btn.classList.toggle('selected');
                const text = btn.textContent;
                if (btn.classList.contains('selected')) {
                    currentTags.push(text);
                } else {
                    currentTags = currentTags.filter(t => t !== text);
                }
            }

            // --- RENDER VIEWS ---
            function renderDashboard() {
                const display = document.getElementById('amalgam-display');
                const form = document.getElementById('amalgam-form');
                if (state.amalgam) {
                    display.classList.remove('hidden'); form.classList.add('hidden');
                    document.getElementById('amalgam-text').textContent = `"${state.amalgam}"`;
                } else {
                    display.classList.add('hidden'); form.classList.remove('hidden');
                }
                const container = document.getElementById('sos-container');
                container.innerHTML = '';
                const items = state.pearls.filter(p => p.kategoria === " SOS");
                if (items.length === 0) container.innerHTML = '<p class="text-xs text-slate-500 text-center py-4">Brak wpis贸w SOS.</p>';
                items.forEach(p => {
                    container.innerHTML += `
                    <div onclick="viewPearl('${p.id}')" class="glass rounded-2xl p-4 border-l-4 border-red-500 flex justify-between items-center mb-3 active:scale-95 transition-transform cursor-pointer relative overflow-hidden">
                        <div class="flex-1 pr-4 pointer-events-none"><h3 class="font-bold text-sm mb-1 text-slate-200">${p.tytul}</h3><p class="text-xs text-slate-400 italic">"${p.trescPorady}"</p></div>
                        <button onclick="deletePearl(event, '${p.id}')" class="p-3 text-slate-500 hover:text-red-400 bg-slate-800/50 rounded-xl z-20 pointer-events-auto"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                    </div>`;
                });
            }

            function renderWiedza() {
                const filterBar = document.getElementById('filter-bar');
                const filters = [
                    { id: 'ALL', label: 'Wszystkie' },
                    { id: ' SOS', label: 'SOS' },
                    { id: ' SLAJD', label: 'Slajd' },
                    { id: ' ZASADA', label: 'Zasada' },
                    { id: ' SPOKJ', label: 'Spok贸j' },
                    { id: ' FINANSE', label: 'Finanse' },
                    { id: 'わ ZDROWIE', label: 'Zdrowie' },
                    { id: ' RELACJE', label: 'Relacje' }
                ];
                filterBar.innerHTML = filters.map(f => `<button onclick="setFilter('${f.id}')" class="filter-btn ${state.filter === f.id ? 'active' : ''}">${f.label}</button>`).join('');

                const container = document.getElementById('wiedza-container');
                container.innerHTML = '';
                let filteredPearls = state.pearls;
                if (state.filter !== 'ALL') filteredPearls = state.pearls.filter(p => p.kategoria === state.filter);
                if (filteredPearls.length === 0) container.innerHTML = '<p class="text-center text-slate-500 mt-10">Pusto.</p>';
                filteredPearls.forEach(p => {
                    let color = 'text-blue-400', border = 'border-blue-500/20', bg = 'bg-blue-500/5';
                    if (p.kategoria === " SOS") { color = 'text-red-400'; border = 'border-red-500/20'; bg = 'bg-red-500/5'; }
                    else if (p.kategoria === " SLAJD") { color = 'text-purple-400'; border = 'border-purple-500/20'; bg = 'bg-purple-500/5'; }
                    else if (p.kategoria.includes("SPOKJ")) { color = 'text-emerald-400'; border = 'border-emerald-500/20'; bg = 'bg-emerald-500/5'; }
                    else if (p.kategoria.includes("FINANSE")) { color = 'text-yellow-400'; border = 'border-yellow-500/20'; bg = 'bg-yellow-500/5'; }
                    else if (p.kategoria.includes("ZDROWIE")) { color = 'text-orange-400'; border = 'border-orange-500/20'; bg = 'bg-orange-500/5'; }
                    else if (p.kategoria.includes("RELACJE")) { color = 'text-pink-400'; border = 'border-pink-500/20'; bg = 'bg-pink-500/5'; }

                    container.innerHTML += `
                    <div class="glass rounded-2xl p-5 border ${border} ${bg} flex justify-between items-start gap-4 mb-4">
                        <div class="flex-1">
                            <p class="text-[10px] font-bold uppercase tracking-wider ${color} mb-2">${p.kategoria}</p>
                            <h3 class="font-bold text-lg text-slate-100">${p.tytul}</h3>
                            <p class="text-sm text-slate-400 mt-2 font-light">"${p.trescPorady}"</p>
                            <div class="mt-3 pt-3 border-t border-white/5"><p class="text-[10px] text-slate-500 uppercase">Afirmacja</p><p class="text-xs font-bold text-emerald-400 uppercase">${p.afirmacjaSkrot}</p></div>
                        </div>
                        <button onclick="deletePearl(event, '${p.id}')" class="p-2 text-slate-500 hover:text-red-400 active:scale-95"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                    </div>`;
                });
            }

            function renderJournal() {
                const container = document.getElementById('journal-container');
                const searchTerm = document.getElementById('journal-search').value.toLowerCase();
                container.innerHTML = '';

                let filtered = state.journal;
                if (state.journalFilter !== 'ALL') filtered = filtered.filter(j => j.status === state.journalFilter);
                if (searchTerm) filtered = filtered.filter(j => j.haczyk.toLowerCase().includes(searchTerm));

                if (filtered.length === 0) {
                    container.innerHTML = '<div class="text-center py-10 text-slate-500 italic"><p>Brak wpis贸w speniajcych kryteria.</p></div>';
                    return;
                }

                filtered.forEach(j => {
                    let borderColor = 'border-slate-500/50';
                    let statusIcon = '';
                    if (j.status === 'fed') { borderColor = 'border-red-500'; statusIcon = ''; }
                    if (j.status === 'ext') { borderColor = 'border-emerald-500'; statusIcon = ''; }

                    const tagsHtml = j.tags ? j.tags.map(t => `<span class="text-[9px] px-2 py-0.5 rounded-full bg-white/5 text-slate-400 border border-white/5">${t}</span>`).join('') : '';
                    const principleHtml = j.zasada ? `<span class="text-[10px] px-2 py-0.5 rounded-lg bg-blue-500/10 text-blue-400 border border-blue-500/20 font-bold uppercase tracking-tighter">${j.zasada}</span>` : '';

                    container.innerHTML += `
                    <div class="glass rounded-2xl p-5 border-l-4 ${borderColor} space-y-4 mb-4 relative overflow-hidden group">
                        <div class="flex justify-between items-start">
                            <div class="flex flex-col gap-1">
                                <span class="text-[10px] text-slate-500 font-medium">${new Date(j.timestamp).toLocaleString('pl-PL')}</span>
                                ${principleHtml}
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs">${statusIcon}</span>
                                <span class="text-[10px] font-bold text-slate-400"> ${j.energia}/5</span>
                            </div>
                        </div>
                        
                        <div>
                            <p class="text-[9px] text-slate-500 uppercase tracking-widest mb-1 opacity-60">Haczyk</p>
                            <p class="text-base font-bold text-slate-100 leading-tight">${j.haczyk}</p>
                        </div>
                        
                        ${tagsHtml ? `<div class="flex flex-wrap gap-1">${tagsHtml}</div>` : ''}
                        
                        ${j.wniosek ? `
                        <div class="pt-3 border-t border-white/5">
                            <p class="text-[9px] text-emerald-400/80 uppercase tracking-widest mb-1">wiadomo / Wniosek</p>
                            <p class="text-xs text-slate-300 italic leading-relaxed">"${j.wniosek}"</p>
                        </div>` : ''}

                        <div class="flex gap-2 pt-2">
                            <button onclick="analyzeJournalAI('${j.id}')" class="btn-action btn-ai">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path></svg>
                                Analizuj AI
                            </button>
                            <button onclick="editJournal('${j.id}')" class="btn-action btn-edit">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                Edytuj
                            </button>
                            <button onclick="deleteJournal('${j.id}')" class="ml-auto text-slate-700 hover:text-red-500 transition-colors">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                    </div>`;
                });
            }

            // --- UTILS & SIDEBAR ---
            function toggleSidebar() {
                const side = document.getElementById('sidebar');
                const over = document.getElementById('sidebar-overlay');
                if (side.classList.contains('open')) {
                    side.classList.remove('open');
                    over.style.display = 'none';
                    over.style.opacity = '0';
                } else {
                    side.classList.add('open');
                    over.style.display = 'block';
                    setTimeout(() => over.style.opacity = '1', 10);
                }
            }

            function sidebarSelect(tabId) {
                switchTab(tabId);
                toggleSidebar();
            }

            function switchTab(tabId) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-${tabId}`).classList.add('active');

                // Scroll do g贸ry przy zmianie zakadki
                const scrollContainer = document.getElementById('main-scroll-container');
                if (scrollContainer) scrollContainer.scrollTop = 0;

                // Update sidebar active state
                document.querySelectorAll('.sidebar-item').forEach(el => {
                    el.classList.remove('active');
                    if (el.id === `side-${tabId}`) el.classList.add('active');
                });

                // Update bottom nav placeholders if still exist elsewhere (optional)
                document.querySelectorAll('.nav-btn').forEach(el => {
                    const target = el.dataset.target;
                    el.classList.remove('text-blue-400', 'text-emerald-400', 'text-purple-400', 'text-slate-500');
                    if (target === tabId) {
                        if (tabId === 'dziennik') el.classList.add('text-emerald-400');
                        else if (tabId === 'analiza') el.classList.add('text-purple-400');
                        else el.classList.add('text-blue-400');
                    } else el.classList.add('text-slate-500');
                });
                refreshAllViews();
            }

            function refreshAllViews() { renderDashboard(); renderWiedza(); renderJournal(); renderChart(); }

            function showToast(msg, isError = false) {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = 'toast' + (isError ? ' error' : '');
                toast.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg> ${msg}`;
                container.appendChild(toast);
                setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
            }

            // --- ACTIONS ---
            function addPearl() {
                try {
                    const title = document.getElementById('p-title').value;
                    if (!title) { alert('Wpisz tytu!'); return; }
                    const newP = { id: Date.now().toString(), kategoria: document.getElementById('p-cat').value, tytul: title, trescPorady: document.getElementById('p-desc').value, afirmacjaSkrot: document.getElementById('p-affirm').value };
                    state.pearls.unshift(newP); save();
                    document.getElementById('p-title').value = ""; document.getElementById('p-desc').value = ""; document.getElementById('p-affirm').value = "";
                    closeModal('pearl'); refreshAllViews(); showToast('Dodano perek!');
                } catch (e) { logError(e.message); }
            }
            function deletePearl(e, id) {
                e.stopPropagation();
                if (confirm('Na pewno usun?')) { state.pearls = state.pearls.filter(p => p.id !== id); save(); refreshAllViews(); showToast('Usunito perek.'); }
            }

            async function addJournal() {
                try {
                    const editId = document.getElementById('j-edit-id').value;
                    const hook = document.getElementById('j-hook').value;
                    if (!hook) { alert("Wpisz chocia偶 haczyk!"); return; }

                    const entryData = {
                        energia: Number(document.getElementById('j-energy').value),
                        haczyk: hook,
                        wniosek: document.getElementById('j-concl').value,
                        status: document.getElementById('j-status').value,
                        zasada: document.getElementById('j-principle').value,
                        tags: [...currentTags]
                    };

                    if (editId) {
                        const idx = state.journal.findIndex(j => j.id === editId);
                        if (idx !== -1) {
                            state.journal[idx] = { ...state.journal[idx], ...entryData };
                        }
                    } else {
                        const newJ = {
                            id: Date.now().toString(),
                            timestamp: Date.now(),
                            ...entryData
                        };
                        state.journal.unshift(newJ);
                    }

                    await save();
                    closeModal('journal');
                    refreshAllViews();
                    showToast(editId ? 'Zaktualizowano wpis!' : 'Dodano wpis!');
                } catch (e) { logError(e.message); }
            }

            function editJournal(id) {
                const j = state.journal.find(x => x.id === id);
                if (!j) return;

                document.getElementById('j-edit-id').value = j.id;
                document.getElementById('j-modal-title').textContent = "Edytuj Wpis";
                document.getElementById('j-submit-btn').textContent = "ZAKTUALIZUJ";

                document.getElementById('j-energy').value = j.energia;
                document.getElementById('j-hook').value = j.haczyk;
                document.getElementById('j-concl').value = j.wniosek || "";
                document.getElementById('j-principle').value = j.zasada || "";
                document.getElementById('j-status').value = j.status || "";

                // Reset tags and select those from entry
                currentTags = [...(j.tags || [])];
                document.querySelectorAll('.tag-btn').forEach(btn => {
                    btn.classList.toggle('selected', currentTags.includes(btn.textContent));
                });

                setPendulumStatus(j.status);
                openModal('journal');
            }

            async function analyzeJournalAI(id) {
                const j = state.journal.find(x => x.id === id);
                if (!j) return;
                if (!state.apiKey) { alert("Prosz wpisa klucz API w ustawieniach."); switchTab('settings'); return; }

                showToast("Nawigator analizuje sytuacj...");
                try {
                    const prompt = `Jeste Nawigatorem Transerfingu Rzeczywistoci. Przeanalizuj poni偶sz sytuacj (Haczyk) i reakcj u偶ytkownika (Wniosek). 
                Haczyk: ${j.haczyk}
                Wniosek: ${j.wniosek}
                Zasada: ${j.zasada || 'nieokrelona'}
                Status: ${j.status === 'fed' ? 'Nakarmiono wahado' : 'Wygaszono wahado'}

                Podaj kr贸tk, konkretn rad w duchu Vadima Zelanda:
                1. Czy wystpi nadmierny potencja?
                2. Jak obni偶y wa偶no?
                3. Jaka kategoria Transerfingu najlepiej tu pasuje?
                Odpowiadaj bezporednio i inspirujco. Maksimum 3-4 zdania.`;

                    const requestBody = {
                        contents: [{ parts: [{ text: prompt }] }],
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                        ]
                    };

                    const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${state.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    if (!resp.ok) {
                        const err = await resp.json();
                        if (resp.status === 429) throw new Error("Limit zapyta wyczerpany. Spr贸buj p贸藕niej.");
                        throw new Error("Bd API: " + (err.error?.message || resp.statusText));
                    }

                    const data = await resp.json();
                    if (!data.candidates || data.candidates.length === 0) throw new Error("AI nie zwr贸cio odpowiedzi.");

                    const advice = data.candidates[0].content.parts[0].text;

                    // Poka偶 wynik w modalu view-pearl lub dedykowanym
                    document.getElementById('view-title').textContent = "Analiza Nawigatora";
                    document.getElementById('view-desc').textContent = advice;
                    document.getElementById('view-affirm').textContent = "Uwa偶no to Twoja tarcza.";
                    const iconContainer = document.getElementById('view-icon');
                    iconContainer.innerHTML = '<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path></svg>';
                    iconContainer.className = "mx-auto p-4 rounded-full bg-purple-900/30 mb-2 w-fit text-purple-400";
                    openModal('view-pearl');
                } catch (err) {
                    showToast("Bd analizy AI: " + err.message, true);
                    console.error(err);
                }
            }
            function deleteJournal(id) { if (confirm('Usun ten wpis?')) { state.journal = state.journal.filter(j => j.id !== id); save(); refreshAllViews(); showToast('Usunito wpis.'); } }

            function openModal(modalName, defCat = null) {
                const modal = document.getElementById(`modal-${modalName}`);
                modal.classList.add('open');
                if (modalName === 'pearl' && defCat) document.getElementById('p-cat').value = defCat;
                if (modalName === 'journal') {
                    // Reset form for new entry
                    document.getElementById('j-edit-id').value = "";
                    document.getElementById('j-modal-title').textContent = "Nowy Wpis";
                    document.getElementById('j-submit-btn').textContent = "ZAPISZ WPIS";
                    document.getElementById('j-energy').value = "3";
                    document.getElementById('j-hook').value = "";
                    document.getElementById('j-concl').value = "";
                    document.getElementById('j-principle').value = "";
                    document.getElementById('j-status').value = "";
                    currentTags = [];
                    document.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('selected'));
                    document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
                }
            }
            function closeModal(name) { document.getElementById(`modal-${name}`).classList.remove('open'); }
            function handleModalClick(e, name) { if (e.target === document.getElementById(`modal-${name}`)) closeModal(name); }

            // --- BACKUP & OTHER ---
            function downloadBackup() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "nawigator_backup_" + new Date().toISOString().slice(0, 10) + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }

            function uploadBackup(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const loadedState = JSON.parse(e.target.result);
                        if (loadedState.pearls && loadedState.journal) {
                            const mode = confirm("Czy chcesz SCALI (Merge) dane z obecnymi? (Dopisze tylko nowe)\n\nAnuluj = Cakowite zastpienie (Overwrite)") ? 'merge' : 'overwrite';
                            if (mode === 'merge') {
                                const epIds = new Set(state.pearls.map(p => p.id));
                                const newP = loadedState.pearls.filter(p => !epIds.has(p.id));
                                state.pearls = [...state.pearls, ...newP];
                                const ejIds = new Set(state.journal.map(j => j.id));
                                const newJ = loadedState.journal.filter(j => !ejIds.has(j.id));
                                state.journal = [...state.journal, ...newJ];
                                showToast(`Scalono: +${newP.length} pereek, +${newJ.length} wpis贸w.`);
                            } else {
                                state = loadedState;
                                showToast('Dane zostay cakowicie zastpione.');
                            }
                            save();
                            refreshAllViews();
                        } else { alert("Bd: Nieprawidowy format pliku kopii."); }
                    } catch (err) { alert("Bd odczytu pliku: " + err.message); }
                };
                reader.readAsText(file);
            }

            function saveApiKey() { state.apiKey = document.getElementById('api-key-input').value; save(); showToast('Zapisano klucz API'); }
            function hardReset() { if (confirm("Usun wszystko?")) { localStorage.clear(); location.reload(); } }

            function speakAmalgam() {
                if (!state.amalgam) return;
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(state.amalgam);
                utterance.lang = 'pl-PL';
                const voices = window.speechSynthesis.getVoices();
                const polishVoice = voices.find(v => v.lang.includes('pl') || v.lang === 'pl-PL');
                if (polishVoice) utterance.voice = polishVoice;
                utterance.rate = 0.9;
                utterance.pitch = 1.0;
                window.speechSynthesis.speak(utterance);
            }
            window.speechSynthesis.onvoiceschanged = () => { console.log("Gosy zaadowane."); };

            function getSmoothPath(points, height, padding) {
                if (points.length === 0) return "";
                if (points.length === 1) return `M ${points[0].x} ${points[0].y}`;
                let path = `M ${points[0].x} ${points[0].y}`;
                for (let i = 0; i < points.length - 1; i++) {
                    const p0 = points[i === 0 ? 0 : i - 1];
                    const p1 = points[i];
                    const p2 = points[i + 1];
                    const p3 = points[i + 2] || p2;
                    const cp1x = p1.x + (p2.x - p0.x) / 6;
                    const cp1y = p1.y + (p2.y - p0.y) / 6;
                    const cp2x = p2.x - (p3.x - p1.x) / 6;
                    const cp2y = p2.y - (p3.y - p1.y) / 6;
                    path += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${p2.x} ${p2.y}`;
                }
                return path;
            }

            function renderChart() {
                const container = document.getElementById('chart-container');
                if (state.journal.length === 0) {
                    container.innerHTML = '<div class="h-full flex items-center justify-center text-slate-500 text-xs">Brak danych</div>';
                    return;
                }
                const dataPoints = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(); d.setDate(d.getDate() - i);
                    const dateStr = d.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit' });
                    const entries = state.journal.filter(j => new Date(j.timestamp).toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit' }) === dateStr);
                    const avg = entries.length ? entries.reduce((s, c) => s + c.energia, 0) / entries.length : 0;
                    dataPoints.push({ date: dateStr, val: avg });
                }
                const h = container.clientHeight || 200;
                const w = container.clientWidth || 300;
                const pad = 30; const max = 5;
                const coords = dataPoints.map((d, i) => ({ x: pad + (i / (dataPoints.length - 1 || 1)) * (w - 2 * pad), y: h - pad - (d.val / max) * (h - 2 * pad), val: d.val, label: d.date.split('.')[0] }));
                const linePath = getSmoothPath(coords, h, pad);

                // TREND LINE
                let trendPath = "";
                if (coords.length > 1) {
                    const n = coords.length;
                    let sx = 0, sy = 0, sxy = 0, sx2 = 0;
                    coords.forEach((p, i) => { sx += i; sy += p.y; sxy += i * p.y; sx2 += i * i; });
                    const m = (n * sxy - sx * sy) / (n * sx2 - sx * sx);
                    const b = (sy - m * sx) / n;
                    const y1 = b;
                    const y2 = m * (n - 1) + b;
                    trendPath = `M ${coords[0].x} ${y1} L ${coords[n - 1].x} ${y2}`;
                }

                const areaPath = `${linePath} L ${w - pad} ${h - pad} L ${pad} ${h - pad} Z`;
                const gridLines = [1, 2, 3, 4, 5].map(v => { const y = h - pad - (v / max) * (h - 2 * pad); return `<line x1="${pad}" y1="${y}" x2="${w - pad}" y2="${y}" stroke="#334155" stroke-width="1" stroke-dasharray="4" opacity="0.3" /><text x="${pad - 10}" y="${y + 3}" fill="#64748b" font-size="9" text-anchor="end">${v}</text>`; }).join('');
                const dots = coords.map(p => { if (p.val === 0) return `<text x="${p.x}" y="${h - 10}" fill="#64748b" font-size="9" text-anchor="middle">${p.label}</text>`; return `<g><circle cx="${p.x}" cy="${p.y}" r="6" fill="#0f172a" stroke="#a855f7" stroke-width="2" /><circle cx="${p.x}" cy="${p.y}" r="3" fill="#fff" /><text x="${p.x}" y="${h - 10}" fill="#94a3b8" font-size="10" text-anchor="middle" font-weight="bold">${p.label}</text></g>`; }).join('');
                container.innerHTML = `<svg viewBox="0 0 ${w} ${h}" class="w-full h-full overflow-visible">
                    <defs>
                        <linearGradient id="grad1" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#a855f7" stop-opacity="0.5" /><stop offset="100%" stop-color="#a855f7" stop-opacity="0" /></linearGradient>
                        <filter id="glow"><feGaussianBlur stdDeviation="2.5" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                    </defs>
                    ${gridLines}
                    <path d="${areaPath}" fill="url(#grad1)" />
                    <path d="${trendPath}" fill="none" stroke="#64748b" stroke-width="1" stroke-dasharray="8" opacity="0.5" />
                    <path d="${linePath}" fill="none" stroke="#d8b4fe" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" filter="url(#glow)" />
                    ${dots}
                </svg>`;

                renderAnalysisStats();
            }

            function renderAnalysisStats() {
                const journal = state.journal || [];
                // 1. BALANCE SCORE
                const total = journal.length;
                const ext = journal.filter(j => j.status === 'ext').length;
                const score = total > 0 ? Math.round((ext / total) * 100) : 0;

                const scoreEl = document.getElementById('balance-score');
                const circleEl = document.getElementById('balance-circle');
                if (scoreEl && circleEl) {
                    scoreEl.textContent = `${score}%`;
                    const offset = 176 - (176 * score) / 100;
                    circleEl.style.strokeDashoffset = offset;
                }

                // 2. TOP PENDULUMS (Nakarmione tagi)
                const fedEntries = journal.filter(j => j.status === 'fed');
                const tagCounts = {};
                fedEntries.forEach(j => {
                    (j.tags || []).forEach(tag => {
                        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                    });
                });

                const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 3);
                const pContainer = document.getElementById('top-pendulums');
                if (pContainer) {
                    if (sortedTags.length > 0) {
                        pContainer.innerHTML = sortedTags.map(([tag, count]) => `
                            <div class="flex justify-between items-center text-[11px]">
                                <span class="text-slate-300">${tag}</span>
                                <span class="bg-red-500/20 text-red-400 px-2 py-0.5 rounded-full font-bold">${count}</span>
                            </div>
                        `).join('');
                    } else {
                        pContainer.innerHTML = '<p class="text-[10px] text-slate-500 text-center py-2 italic uppercase">Czyste Niebo</p>';
                    }
                }
            }

            function resetAmalgam() { state.amalgam = ""; save(); renderDashboard(); }

            async function runWeeklyAIReview() {
                if (!state.apiKey) { alert('Podaj klucz API w ustawieniach!'); switchTab('settings'); return; }
                const reviewEl = document.getElementById('weekly-ai-review');
                const btn = document.getElementById('btn-weekly-ai');

                const last7Days = state.journal.filter(j => {
                    const diff = Date.now() - new Date(j.timestamp).getTime();
                    return diff < 7 * 24 * 60 * 60 * 1000;
                });

                if (last7Days.length === 0) {
                    showToast("Brak wpis贸w z ostatniego tygodnia do analizy.", true);
                    return;
                }

                btn.innerHTML = '...'; btn.disabled = true;
                reviewEl.innerHTML = '<div class="flex items-center gap-2"><div class="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div> czenie z Mentorem...</div>';

                try {
                    const summaryData = last7Days.map(j => `- [${j.status === 'fed' ? 'PORA呕KA' : 'SUKCES'}] Tagi: ${j.tags.join(',')}, Haczyk: ${j.haczyk}`).join('\n');
                    const prompt = `Jeste Mentorem Transerfingu. Przeanalizuj tygodniowy dziennik u偶ytkownika i znajd藕 wzorce:
                    ${summaryData}
                    
                    Napisz kr贸tki (3-4 zdania) przegld tygodnia dla u偶ytkownika:
                    1. Jakie wahado najczciej go atakuje?
                    2. Co robi dobrze?
                    3. Jedna konkretna rada na przyszy tydzie.
                    Styl: Inspirujcy, konkretny, w duchu Vadima Zelanda.`;

                    const requestBody = {
                        contents: [{ parts: [{ text: prompt }] }],
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                        ]
                    };

                    const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${state.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    if (!resp.ok) throw new Error("Bd API");
                    const data = await resp.json();
                    const review = data.candidates[0].content.parts[0].text;
                    reviewEl.innerHTML = review;
                    reviewEl.classList.remove('text-center', 'italic');
                    reviewEl.classList.add('text-left');
                } catch (err) {
                    reviewEl.innerHTML = "Bd poczenia z Mentorem AI.";
                    showToast("Bd AI Review", true);
                } finally {
                    btn.innerHTML = 'Generuj'; btn.disabled = false;
                }
            }

            // --- API CALL (GEMINI 2.5 FLASH) ---
            async function generateAmalgam() {
                const problem = document.getElementById('challenge-input').value;
                if (!problem) return;
                if (!state.apiKey) { alert('Podaj klucz API w ustawieniach!'); switchTab('settings'); return; }

                const btn = document.getElementById('btn-generate');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '...'; btn.disabled = true;

                try {
                    const requestBody = {
                        contents: [{ parts: [{ text: `Jeste Vadimem Zelandem. Kr贸tka (1 zdanie), mocna afirmacja dla kierowcy ci偶ar贸wki na problem: "${problem}".` }] }],
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                        ]
                    };

                    // U呕YWAMY MODELU 2.5 FLASH
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${state.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        if (response.status === 429) throw new Error("Limit zapyta wyczerpany. Spr贸buj p贸藕niej.");
                        throw new Error("Bd API: " + (err.error?.message || response.statusText));
                    }

                    const data = await response.json();
                    if (!data.candidates || data.candidates.length === 0) throw new Error("AI nie zwr贸cio odpowiedzi.");

                    state.amalgam = data.candidates[0].content.parts[0].text;
                    save();
                    document.getElementById('challenge-input').value = '';
                    renderDashboard();
                    showToast('Gotowe!');
                } catch (e) {
                    showToast(e.message, true);
                }
                btn.innerHTML = originalHTML; btn.disabled = false;
            }

            // --- SWIPE LOGIC ---
            let touchstartX = 0;
            let touchendX = 0;

            function handleGesture() {
                if (touchendX < touchstartX - 70) navigateTabs(1);
                if (touchendX > touchstartX + 70) navigateTabs(-1);
            }

            function navigateTabs(direction) {
                const tabs = ['dashboard', 'wiedza', 'dziennik', 'analiza'];
                const cur = document.querySelector('.view-section.active')?.id.replace('tab-', '');
                let idx = tabs.indexOf(cur);
                if (idx !== -1) {
                    idx += direction;
                    if (idx >= 0 && idx < tabs.length) switchTab(tabs[idx]);
                }
            }

            document.getElementById('main-scroll-container').addEventListener('touchstart', e => {
                touchstartX = e.changedTouches[0].screenX;
            }, { passive: true });

            document.getElementById('main-scroll-container').addEventListener('touchend', e => {
                touchendX = e.changedTouches[0].screenX;
                handleGesture();
            }, { passive: true });

            function toggleBreatheSection() {
                const sec = document.getElementById('breathe-section');
                state.breatheCollapsed = !state.breatheCollapsed;
                sec.classList.toggle('section-collapsed', state.breatheCollapsed);
                save();
            }

            function startBreatheCycle() {
                const fazeEl = document.getElementById('breathe-faze');
                const timerEl = document.getElementById('breathe-timer');
                const circle = document.querySelector('.breathe-circle');

                const syncAnimation = () => {
                    const now = Date.now();
                    const progress = now % 12000;
                    if (circle) circle.style.animationDelay = `-${progress}ms`;
                };
                syncAnimation();

                setInterval(() => {
                    const now = Date.now();
                    const cycle = 12000; // 12s cycle (4s in, 4s hold, 4s out)
                    const progress = now % cycle;

                    if (progress < 4000) {
                        const timeLeft = Math.ceil((4000 - progress) / 1000);
                        if (fazeEl.textContent !== 'WDECH') {
                            fazeEl.textContent = 'WDECH';
                            fazeEl.style.color = '#c084fc';
                        }
                        timerEl.textContent = timeLeft;
                    } else if (progress < 8000) {
                        const timeLeft = Math.ceil((8000 - progress) / 1000);
                        if (fazeEl.textContent !== 'ZATRZYMAJ') {
                            fazeEl.textContent = 'ZATRZYMAJ';
                            fazeEl.style.color = '#fbbf24';
                        }
                        timerEl.textContent = timeLeft;
                    } else {
                        const timeLeft = Math.ceil((12000 - progress) / 1000);
                        if (fazeEl.textContent !== 'WYDECH') {
                            fazeEl.textContent = 'WYDECH';
                            fazeEl.style.color = '#818cf8';
                        }
                        timerEl.textContent = timeLeft;
                    }
                }, 100);
            }

            window.onload = async () => {
                await loadState();
                document.getElementById('api-key-input').value = state.apiKey;

                // Restore breathe section state
                if (state.breatheCollapsed) {
                    document.getElementById('breathe-section').classList.add('section-collapsed');
                }

                startBreatheCycle();
                switchTab('dashboard');
                setTimeout(renderChart, 100);
            };
        </script>
</body>

</html>